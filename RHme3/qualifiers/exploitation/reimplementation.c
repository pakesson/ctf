/*
    Reimplementation of qualifier challenge 3 (exploitation) in the RHme3 CTF

    Compile with
      $ gcc -no-pie -o reimplementation reimplementation.c
    or
      $ gcc -g -no-pie -o reimplementation reimplementation.c
    to include debug symbols.
 */

#include <stdint.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>

typedef struct __attribute__((__packed__)) {
    int32_t attack_points;
    int32_t defense_points;
    int32_t speed;
    int32_t precision;
    char *name;
} player_t;

player_t *selected = NULL;
player_t *players[11] = {0,};

void readline(char *dst, size_t max_bytes)
{
    size_t n = 0;
    while (n < max_bytes - 1)
    {
        char input;
        read(STDIN_FILENO, &input, 1);
        if (input == 0xa)
        {
            break;
        }
        dst[n] = input;
        ++n;
    }
    dst[n] = '\0';
}

int menu()
{
    puts("0.- Exit");
    puts("1.- Add player");
    puts("2.- Remove player");
    puts("3.- Select player");
    puts("4.- Edit player");
    puts("5.- Show player");
    puts("6.- Show team");
    printf("Your choice: ");
    fflush(stdout);

    char input[4];
    readline(input, 4);

    return atoi(input);
}

int edit_menu()
{
    puts("0.- Go back");
    puts("1.- Edit name");
    puts("2.- Set attack points");
    puts("3.- Set defense points");
    puts("4.- Set speed");
    puts("5.- Set precision");
    printf("Your choice: ");
    fflush(stdout);

    char input[4];
    readline(input, 4);

    return atoi(input);
}

void show_player_func(player_t *player)
{
    printf("\tName: %s\n", player->name);
    fflush(stdout);
    printf("\tA/D/S/P: %d,%d,%d,%d\n",
        player->attack_points,
        player->defense_points,
        player->speed,
        player->precision);
    fflush(stdout);
}

void add_player()
{
    int index;
    for (index = 0; index < 11; ++index)
    {
        if (players[index] == NULL)
        {
            break;
        }
    }

    if (index == 11)
    {
        puts("Maximum number of players reached!");
        fflush(stdout);
        return;
    }

    printf("Found free slot: %d\n", index);
    fflush(stdout);

    player_t *new_player = (player_t *)malloc(sizeof(player_t));
    if (new_player == NULL)
    {
        puts("Could not allocate");
        fflush(stdout);
        return;
    }

    memset(new_player, 0, sizeof(player_t));

    printf("Enter player name: ");
    fflush(stdout);

    char input[0x100];
    memset(input, 0, 0x100);
    readline(input, 0x100);

    new_player->name = (char *)malloc(strlen(input) + 1);
    if (new_player->name == NULL)
    {
        printf("Could not allocate!");
        fflush(stdout);
    }
    strcpy(new_player->name, input);

    printf("Enter attack points: ");
    fflush(stdout);
    readline(input, 4);
    new_player->attack_points = atoi(input);

    printf("Enter defense points: ");
    fflush(stdout);
    readline(input, 4);
    new_player->defense_points = atoi(input);

    printf("Enter speed: ");
    fflush(stdout);
    readline(input, 4);
    new_player->speed = atoi(input);

    printf("Enter precision: ");
    fflush(stdout);
    readline(input, 4);
    new_player->precision = atoi(input);

    players[index] = new_player;
}

void delete_player()
{
    printf("Enter index: ");
    fflush(stdout);

    char input[4];
    readline(input, 4);
    int index = atoi(input);

    if (index > 10 || players[index] == NULL)
    {
        puts("Invalid index");
        fflush(stdout);
        return;
    }

    player_t *tmp = players[index];
    players[index] = NULL;

    free(tmp->name);
    free(tmp);

    puts("She's gone!");
    fflush(stdout);
}

void select_player()
{
    printf("Enter index: ");
    fflush(stdout);

    char input[4];
    readline(input, 4);
    int index = atoi(input);

    if (index > 10 || players[index] == NULL)
    {
        puts("Invalid index");
        fflush(stdout);
        return;
    }

    selected = players[index];

    puts("Player selected!");
    fflush(stdout);

    show_player_func(selected);
}

void set_name()
{
    printf("Enter new name: ");
    fflush(stdout);

    char input[0x100];
    readline(input, 0x100);

    if (strlen(input) > strlen(selected->name))
    {
        char *new_name = (char *)realloc(selected->name, strlen(input) + 1);

        if (new_name == NULL)
        {
            puts("Could not realloc :(");
            fflush(stdout);
            return;
        }

        selected->name = new_name;
    }

    strcpy(selected->name, input);
}

void set_attack()
{
    printf("Enter attack points: ");
    fflush(stdout);

    char input[4];
    readline(input, 4);

    selected->attack_points = atoi(input);
}

void set_defense()
{
    printf("Enter defense points: ");
    fflush(stdout);

    char input[4];
    readline(input, 4);

    selected->defense_points = atoi(input);
}

void set_speed()
{
    printf("Enter speed: ");
    fflush(stdout);

    char input[4];
    readline(input, 4);

    selected->speed = atoi(input);
}

void set_precision()
{
    printf("Enter precision: ");
    fflush(stdout);

    char input[4];
    readline(input, 4);

    selected->precision = atoi(input);
}

void edit_player()
{
    if (selected == NULL)
    {
        puts("No player selected!!");
        fflush(stdout);
        return;
    }

    int8_t done = 0;
    while (!done)
    {
        int choice = edit_menu();

        switch (choice)
        {
            case 0:
                done = 1;
                break;
            case 1:
                set_name();
                break;
            case 2:
                set_attack();
                break;
            case 3:
                set_defense();
                break;
            case 4:
                set_speed();
                break;
            case 5:
                set_precision();
                break;
            default:
                puts("Invalid choice");
                fflush(stdout);
                break;
        }
    }
}

void show_player()
{
    if (selected == NULL)
    {
        puts("No player selected index");
        fflush(stdout);
        return;
    }
    show_player_func(selected);
}

void show_team()
{
    puts("Your team: ");
    fflush(stdout);

    for (int i = 0; i < 11; ++i)
    {
        if (players[i] != NULL)
        {
            printf("Player %d\n", i);
            fflush(stdout);

            show_player_func(players[i]);
        }
    }
}

int main(int argc, char *argv[])
{
    printf("Size of player_t: %d\n", sizeof(player_t));
    printf("Address of selected: %p\n", &selected);
    printf("Address of players: %p\n", &players);
    puts("------");

    puts("Welcome to your TeamManager (TM)!");

    int8_t done = 0;
    while (!done)
    {
        int choice = menu();

        switch (choice)
        {
            case 0:
                done = 1;
                break;
            case 1:
                add_player();
                break;
            case 2:
                delete_player();
                break;
            case 3:
                select_player();
                break;
            case 4:
                edit_player();
                break;
            case 5:
                show_player();
                break;
            case 6:
                show_team();
                break;
            default:
                puts("Invalid option!!");
        }
    }

    puts("Sayonara!");

    return 0;
}